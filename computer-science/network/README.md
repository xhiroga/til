# ネットワーク (network)

章立てはシンプルさを重視してTCP/IPモデルに則る。各層の名前はWikipediaに準拠する。[^wikipedia_ip]
[^wikipedia_ip]: [インターネット・プロトコル・スイート](https://ja.wikipedia.org/wiki/インターネット・プロトコル・スイート)

## 基礎知識

## リンク層

リンク層のネットワーク機器について、次の通りまとめた。

| MACアドレス | ポート数 | 名前                                          |
| ----------- | -------- | --------------------------------------------- |
| 学習しない  | 2        | （狭義の）リピータ                            |
| 学習しない  | 3以上    | ハブ (リピータハブ)                           |
| 学習する    | 2        | （狭義の）ブリッジ                            |
| 学習する    | 3以上    | スイッチ (ブリッジングハブ, スイッチングハブ) |

ブリッジとリピーターの違いについて。リピーターは信号を増幅するだけだが、ブリッジはフレームに含まれるMACアドレスを読んで適切な宛先に転送ができる。そのため、不要なフレーム転送がなくなる。

リンク層のネットワークには、媒体共有型と媒体非共有型がある。いずれの場合も同じネットワークに複数のホストがいるため、通信したいホスト同士で通信するための仕組みが必要である。

### CSMA/CD方式

媒体共有型のネットワークにおける制御方法。前提として、物理的なネットワークで異なる電気信号が同時に流れると、データが衝突して壊れてしまう。それに対して、各ノード[^node]がデータを送信したいタイミングで好き勝手に送信する方式があり、これをコンテンション (Contention) 方式と呼ぶ。
[^node]: なお、リンク層ではノードをステーションと呼ぶことが多い。

コンテンション方式は、データが衝突してから解消するまでに時間がかかる欠点があるため、改良した方式としてCSMA/CD (Carrier Sense Multiple Access with Collision Detection) 方式がある。通信の成否だけでなく衝突の発生を積極的に検出する点や、再送タイミングを決定するアルゴリズムに変化がある。

### トークンパッシング方式

## インターネット層

ネットワーク層とデータリンク層の関係は、旅行代理店の比喩が分かりやすい。旅行者が旅行代理店に行き先を伝えると、旅行代理店が現地までの電車や飛行機などを手配してくれる、というものである。旅行代理店の場合は、事前に経路が分かっている。しかし、実際のネットワーク通信では、ノードはどのルーターを通るかを事前に調べているのだろうか？

実際のネットワーク通信では、事前に経由するルーターを全て把握する必要はなく（仮にそうだとしたら、ISPがルーターの交換作業をする度にネットワークの再接続が起きそうじゃないですか？）、パケットを受け取ったノードそれぞれが、隣り合うノードの中で宛先のIPアドレスに最も近いノードにパケットを送ることを繰り返している。といっても、IPv4アドレスは$2^{32} = 4294967296$種類もある。1エントリあたり僅か16バイト[^16byte]で見積もっても64GB必要になってしまうし、そもそも経路情報の交換が頻繁に発生しすぎて通信どころではないのではないか。そこで、ひとかたまりのIPアドレスをネットワークとみなして管理しよう、という発想になる。
[^16byte]: IPアドレス4バイト、ネクストホップ4バイト、その他8バイトで計算。

### WAN/LAN

ISPと契約しないでも利用可能なネットワークをLAN, 契約が必要なものをWANと考えて良さそうだ。

### IPv4

IPv4アドレスは、IP通信を行うノードを識別するためのIDである。NICに割り当てるため、例えばEthernetとWiFiの2つのインターフェースを持つマザーボードのマシンは、2つのIPアドレスを持つ。また、ルーターは2つ以上のNICを持つため、2つ以上のIPアドレスを持つ。データの単位はパケット。

<!-- > [!NOTE] ルーターにループするようにLANケーブルを挿してはいけないのはなぜ？ -->

#### クラス

当初IPアドレスはA,B,C,D,Eの5クラスに分類されており、クラスごとにネットワーク部とホスト部が分けられていた。しかし、クラスAやBのアドレスが効率的に使われないことから、柔軟にネットワーク部とホスト部を分ける必要が出てきた。

#### サブネットマスク

サブネットマスクは、経路制御の表において、複数のIPアドレスを自由に束ねることができる。ネットワーク部とホスト部を分けているんだから単にマスクもしくはネットマスクで良いのでは？というのは良い視点で、Aクラスを`/24`でマスクするなどAやBクラスよりも下位のマスクが可能だからサブネットマスクと呼ばれているそうだ。[^milestone-of-se_subnet]
[^milestone-of-se_subnet]: [【図解】初心者にも分かるサブネットマスクとデフォルトゲートウェイ](https://milestone-of-se.nesuke.com/nw-basic/ip/subnet-mask-and-default-gateway/)

ところでIP通信では、データリンク層で直接繋がっているノード間ではMACアドレスで通信を行う。具体的には、`arp`リクエストを送ってIPアドレスからMACアドレスを取得する。ここで仮に、自分が所属しているサブネットが分からないとしよう。経路制御のテーブルには、隣のノードからもらったエントリに+1ホップした値を記録するから、隣のノードが自分自身をホップ数0として紹介してくれればそれで済みそうである。しかし大規模なネットワークを考えると、サブネット内にデバイスが出たり入ったりする度に、全てのデバイスと経路情報を交換し合うというのは明らかに効率が悪い。そこで、ホストがルーターに接続した際、予めホスト自身が直接接続できるサブネットが渡されるようになっている。これはDHCPの枠組みで行われる。

#### CIDRとVLSM

次に、ホストではなくルーターがネットワークに接続する場合を考える。ネットワークにルーターを追加することは、新たにサブネットを切り出すことを意味する。

従来はサブネットマスクが固定長だったため、割当予定のサブネット内で最大のホスト数を持つサブネットに合わせてサブネットの大きさを決めていた。しかし、サブネット毎にホスト数が大きく違う場合は無駄が生じる。そこでサブネットマスクの大きさを可変にできるようになった（VLSM）。

VLSMを用いたサブネット構築の演習問題を次の通りまとめた。

- [◆VLSMにおけるサブネットの分割方法](https://atnetwork.info/ccna3/vlsm03.html)
- [ルーティング編<第3回>　VLSMと経路集約](https://xtech.nikkei.com/it/article/COLUMN/20060205/228596/)

<!-- AWSのVPCの最適なサブネット切りの考察 -->

<!-- 1人1つIPアドレスを持っていた日本の会社の話 -->

<!-- > [!NOTE] キリ番のIPアドレスってどうやって取得してるの？ -->

#### NAT

静的IPアドレスを動的IPアドレスに変換する技術。あえて包含関係で言えば、NAT ⊇ NAPT ⊇ IPマスカレード、となる。

IPv4を延命するための技術としての説明をよく見かけるが、「すでにプライベートIPアドレスで構築したLANをインターネットに接続する際に、グローバルIPアドレスへの付け替えをしないで良い」という利点もあったようだ。[^yamaha_2018]なお前提として、1990年代頃にはプロバイダから複数のIPアドレスをもらえた時代があった。[^nec_1999]
[^yamaha_2018]: [NATとIPマスカレードって？](https://www.rtpro.yamaha.co.jp/RT/FAQ/Intro/nat.html)
[^nec_1999]: [Aterm導入マニュアル](https://www.aterm.jp/support/manual2/lib/ir450/irman-d4.pdf#page=302)

主にIPv4で用いられるが、セキュリティ向上のためにIPv6で用いる例もある。

<!-- > [!NOTE] グローバルIPアドレスを共有しているマンションって、ポート番号を使い切ったりしないの？また、IPアドレスの開示請求で困らない？ -->

##### NAT Traversal

##### UDP hole punching

### IPv6

> [!NOTE] IPv4は繋がらないのにIPv6は繋がる事象ってなぜ起きるの？
> IPv4ではNATが必要だが、IPv6では不要となっている。そのため、NATの設定が誤っている際にIPv6だけが通信可能になる。これは家庭では、ルーターが二重になっている際によく見られる。

<!-- https://x.com/xhiroga/status/1731655265290981481 -->

> [!NOTE] IPアドレスの開示請求とIPv6って関係ある？
> 注意: 筆者は法律の専門的知識を持ち合わせていません。
>
> インターネットで誹謗中傷を受けた場合等に、発信者に対して損害賠償請求等を行う前提として、個人を特定する必要があります。
> 通常はコンテンツプロバイダ（例えば5ch）にIPや電話番号の開示請求 → ISPに開示請求の順番で個人を特定しますが、コンテンツプロバイダから開示されたIPアドレスがIPv6の場合はどうなるのでしょうか？
> IPv4では複数のデバイスが同じIPアドレスを利用している可能性があるため、同じISPのIPアドレスから複数人が同時に同じコンテンツプロバイダにアクセスしている可能性があります（そのため、ISPへの請求時にはタイムスタンプを含める）
> IPv6ではデバイスごとにIPアドレスが異なるため、コンテンツプロバイダに保存されているIPアドレスのみで個人の特定がしやすくなると言えそうです。

### DNS

> [!NOTE] IPアドレスの代わりにドメイン名を直接使えないの？
> 仮に実現するとして、次のような技術が必要になると思われる。
>
> 1. ARPに相当する技術（ドメイン名からMACアドレスを引き当てる）
> 2. 経路集約に関する技術
>
> 特に経路集約について考えたい。IPアドレスでは、IPアドレスの階層性を保つようにISPに配布すること、およびCIDRで階層性を表現することで経路集約を容易にしている。
> 一方で、ドメイン名はエンドユーザーが自由に選ぶことのできる文字列である。したがって経路集約は容易ではない。結局階層性を保つにはトップダウンの構造が必要であり、IPアドレスのような単純が数字が適している、ということだろう。

<!-- > [!NOTE] DNSで浸透と言ってはいけないの？ -->

<!-- > [!NOTE] UnicodeのURLって、リンクを貼るときにそのままでいいの？URLエンコードすべき？ -->

### ICMP

IPプロトコルの管理のためのメタ的なプロトコル。トランスポート層のプロトコルだが、インターネット層のような扱いを受ける。`ping`や`traceroute`で利用されている他、IPプロトコルについてのエラーメッセージはICMPで送信される。

## トランスポート層

### TCP

データの単位はセグメント。

IPv4, IPv6では、ネットワークの経路上の問題でパケットが届かなかった場合に、再送を行うのはスコープの範囲外である。TCPでは、受信側がAWKを返さない場合は自動で再送が行われる。

輻輳について説明する。混雑を意味する、通信工学分野の congestion の訳語であるが、日本古来の単語である。日本国語大辞典によれば、770年に記録された、南インド出身の僧ボーディセーナの碑文にも「於是道俗輻輳」との記載がある。[^minamitennjikubaramonnsoujou]
[^minamitennjikubaramonnsoujou]: [南天竺波羅門僧正碑幷序](https://www.senshu-u.ac.jp/~off1024/nenpyoushiryou/minamitennjikubaramonnsoujou/minamitennjikubaramonsoujouhi-736-0823.htm)

> [!NOTE] 受信ホストが求めているシーケンス番号のセグメントが送信失敗している時、そのシーケンス番号とウインドウサイズの和を超えるシーケンスのセグメントの送信を自重するのはどうして？
> 例えば、受信ホストのウィンドウサイズが5000で、受信ホストがシーケンス番号1000を求めており、2000~5000はすでに受け取っている場合、なぜシーケンス番号6000のセグメントを送る仕様にしなかったのだろうか？  
> ウィンドウサイズが余っているなら、順序を問わずに次々セグメントを送ってしまおう、というのは一見効率が良さそうに見える。  
> セグメントを順序立てるメリットとして、全てのACK応答を送らなくてもよいことが挙げられる。実際、複数のACK応答を1つにまとめる遅延ACKという実装が存在する。  
> また推測になるが、TCPの策定当初はネットワークの信頼性が現在よりも低かったのではないか。上位レイヤーのメッセージを分割したセグメントを順不同で送信するということは、セグメントの応答確認をセグメント毎に行う必要がある。極端な話で言えば、あるセグメントの応答確認のパケットをルーターが"苦手"としていた場合、送信ホストはいつまでもそのセグメントを再送することになる。  
> また、セグメント間が順不同の場合は、応答のないセグメントが往復路のどちらで失敗しているかの手がかりに、他のセグメントの応答を用いることができない。そのため、再送の判断はタイムアウトで行うしかなくなってしまう。

#### RTT/SRTT

TCPは様々なネットワーク環境で利用されているため、TCPそのものに固定のタイムアウト時間はない。パケットを送信する毎に往復にかかった時間 = RTT (Round Trip Time) を計測し、そのRTTよりも少し長い時間待っても応答が無ければ再送する。また、RTTにはブレがあるため、常に最新のRTTを用いて平滑化を行っており、これをSRTTと言う。古いSRTT9割に対して新たに観測したRTT1割の割合で重み付き平均を取って更新しており、うなぎのタレを継ぎ足すようなイメージ。

また、再送待ちの時間は指数関数的に増加するようになっている。

### UDP

データの単位はデータグラム。

### ポート番号

TCP/UDPでは、パケットを目的のプロセスに届けるためにポート番号が含まれている。しかし、より具体的にプロセス識別子を用いたり、あるいは抽象的にアプリケーションのID（そんなものは存在しないが、敢えて言えばmacOS, iOSにおけるバンドルID）を用いることで、新たにIDを増やすことを避けなかったのはなぜだろうか？TCPはクライアント・サーバーを区別しないプロトコルなので、プロセス識別子のような予め予測できない値を用いると通信を待ち受けるのが困難になる。一方、アプリケーションのIDを用いるとクライアント側がアプリケーションを多重起動するのが困難になる。よって新たに番号を設けて通信を識別したものと考えられる。

TCPとUDPで同じポート番号を利用しても、通信が混線することはない。では、なぜTCPとUDPは同じ仕様のポート番号を使っているのだろうか？UDPのRFCを読んでみたが、理由は分からなかった。[^rfc768]
[^rfc768]: [RFC768](https://datatracker.ietf.org/doc/rfc768/)

## ルーティングプロトコル

ルーターは、ヘッダーのIPアドレスを見てパケットを転送するインターフェースを決める機能がある。YAMAHA RTX1210で経路情報を出力した結果が次の通り。

```rt
> show ip route 
Destination         Gateway          Interface       Kind  Additional Info.
default             192.168.1.1      LAN2(DHCP)    static  
192.168.1.0/24      192.168.1.250          LAN2  implicit  
192.168.100.0/24    192.168.100.1          LAN1  implicit  
```

経路情報を動的に更新するためのプロトコルを、次の通り分類する。

| 種類 | ルーティングタイプ | 経路制御方式   | プロトコル |
| ---- | ------------------ | -------------- | ---------- |
| IGPs | ユニキャスト       | 距離ベクトル型 | RIP        |
| IGPs | ユニキャスト       | 距離ベクトル型 | RIP2       |
| IGPs | ユニキャスト       | リンク状態型   | OSPF       |
| IGPs | マルチキャスト     | 距離ベクトル型 | DVMRP      |
| IGPs | マルチキャスト     | リンク状態型   | MOSPF      |
| EGPs | ユニキャスト       | パスベクトル型 | BGP        |

> [!NOTE] IGPsとEGPsを分けたとしても、IPヘッダを見てパケットを転送する以上は、EGPsスピーカーではないルーターも巨大な経路制御表を持つことにならない？
> たしかにEGPsでやり取りされる経路制御表は巨大である。ISPの数で考えてもほとんどAS番号と同じだけ（約10万）存在する上、ISPの保有するIPアドレスのネットワーク部が飛び地のために経路集約できないことも普通だから、フルBGPテーブルのエントリは100万以上になる。しかし、ISPでEGPsスピーカー（以降エッジルーター）同士をつなぐルーターが必ずしもハブのような役割を果たすわけではないらしい。むしろエッジルーターが転送先のルーターを慎重に選ぶことで、転送先のルーターがパケットをデフォルトゲートウェイとなる別のエッジルーターに転送するだけで済むようになっているようだ。[^nikkei_2007]
[^nikkei_2007]: [IPパケットはプロバイダ内をどのように転送されるのか](https://xtech.nikkei.com/it/article/COLUMN/20071009/284027/)

### RIP/RIP2

ホストは自分が知っている経路制御表を30秒ごとにブロードキャストする。経路制御表を受け取ったホストは、受け取った経路情報で自分が持っていた経路情報を更新し、それをブロードキャストする。このアルゴリズムはベルマン・フォード法に則っている。

### OSPF

各ルーターはAS内のネットワーク構造をグラフとして持つ。グラフを更新次第、ルーターは各宛先への最短距離をダイクストラ法で計算し、ネクストホップをルーティングテーブルに登録する。

最短経路について、RIPではルーターのホップ数で計算していたが、OSPFではサブネット毎に自由にコストを付与できる。例えば、LANケーブルが古いなどで遅いネットワークではコストを重くする運用が考えられる。

### BPG

AS間の通信経路を定めるために用いるプロトコル。パスベクトル型といい、向きと距離だけでなく、途中で経過するAS番号も全て持っている。それにより、無限カウントを避けたり、ポリシーによってパケット毎に経路を選んだりしやすくなる。

> [!NOTE] 全ASとの通信経路を持っているとしたら、エントリ数が膨大にならない？
> なる。AS番号は約10万だが、エントリ数は100万行以上に達する。したがって、経路表は差分更新を行っている。

## アプリケーション層

### DHCP

ホストがIPv4でネットワークに接続するために必要な設定を払い出してもらうためのプロトコル。サブネットマスク・デフォルトゲートウェイ・DNSサーバーの他に、NTPサーバーのアドレスを受け取ることもできる。

ネットワークの混雑を考慮しなくて良い特性のためか、UDPが用いられている。

### HTTP/HTTPS

#### キャッシュ

HTTPにおいてキャッシュといえばCDNを用いたキャッシュを指す。一方で、かつてはトランスペアレントキャッシュという仕組みがあった。ISPがL4の通信を監視し、適宜コンテンツをキャッシュして返す、という仕組みだったと推察される。[^naogya]クライアントとサーバーのいずれかもキャッシュを意識できないため、トランスペアレント (透過的) という名がついているようだ。しかし、HTTPSの普及で通信の内容を監視できなくなり、またユーザーごとに動的に生成されるコンテンツが増えたことから、CDNに役割を譲ったと考えて良さそうだ。[^senki_2014]
[^naogya]: [1. Web トランスペアレントキャッシュについての概要](https://old.kitadake.net/hit-u/research/cn/58/WebCache/node1.html)
[^senki_2014]: [Is “Transparent” Web Caching Dead?](https://www.senki.org/transparent-web-caching-dead/)

### QUIC

UDP上に築かれているため便宜上アプリケーション層のプロトコルとして説明するが、HTTP/3の基盤でもあるため、従来のTCP/IPモデルでの分類は難しい。

### SSL/TLS

1990年代、eコマースの登場によって安全な取引が急務となった。NetscapeはSSLを、MicrosoftはPCTを開発し、SSLが標準となった。後継プロトコルのTLSにはPCTの知見も取り入れられている。

SSL/TLSでは、公開鍵暗号方式を採用している。

<!-- > [!NOTE] 通信の開始から終了まで、全てのプロセスで公開鍵暗号を用いる、より厳密な通信方法も存在するの？ -->

<!-- > [!NOTE] TCP/IPが暗号化をサポートすれば、HTTPSやSSHなどが個別に対応しなくてよかったんじゃないの？ -->

## References

[マスタリングTCP/IP](https://amzn.to/3x7Mq7z)
