# ネットワーク (network)

## 基礎知識

## データリンク

## IP

ネットワーク層とデータリンク層の関係は、旅行代理店の比喩が分かりやすい。旅行者が旅行代理店に行き先を伝えると、旅行代理店が現地までの電車や飛行機などを手配してくれる、というものである。旅行代理店の場合は、事前に経路が分かっている。しかし、実際のネットワーク通信では、ノードはどのルーターを通るかを事前に調べているのだろうか？

実際のネットワーク通信では、事前に経由するルーターを全て把握する必要はなく（仮にそうだとしたら、ISPがルーターの交換作業をする度にネットワークの再接続が起きそうじゃないですか？）、パケットを受け取ったノードそれぞれが、隣り合うノードの中で宛先のIPアドレスに最も近いノードにパケットを送ることを繰り返している。といっても、IPアドレスは$2^{32} = 4294967296$種類もある。1エントリあたり僅か16バイト[^16byte]で見積もっても64GB必要になってしまうし、そもそも経路情報の交換が頻繁に発生しすぎて通信どころではないのではないか。そこで、ひとかたまりのIPアドレスをネットワークとみなして管理しよう、という発想になる。

[^16byte]: IPアドレス4バイト、ネクストホップ4バイト、その他8バイトで計算。

### IPv4

IPv4アドレスは、IP通信を行うノードを識別するためのIDである。NICに割り当てるため、例えばEthernetとWiFiの2つのインターフェースを持つマザーボードのマシンは、2つのIPアドレスを持つ。また、ルーターには2つ以上のNICを持つため、2つ以上のIPアドレスを持つ。

#### クラス

当初IPアドレスはA,B,C,D,Eの5クラスに分類されており、クラスごとにネットワーク部とホスト部が分けられていた。しかし、クラスAやBのアドレスが効率的に使われないことから、柔軟にネットワーク部とホスト部を分ける必要が出てきた。

#### サブネットマスク

サブネットマスクは、経路制御の表において、複数のIPアドレスを自由に束ねることができる。ネットワーク部とホスト部を分けているんだから単にマスクもしくはネットマスクで良いのでは？というのは良い視点で、Aクラスを`/24`でマスクするなどAやBクラスよりも下位のマスクが可能だからサブネットマスクと呼ばれているそうだ。[^milestone-of-se_subnet]

[^milestone-of-se_subnet]: [【図解】初心者にも分かるサブネットマスクとデフォルトゲートウェイ](https://milestone-of-se.nesuke.com/nw-basic/ip/subnet-mask-and-default-gateway/)

ところでIP通信では、データリンク層で直接繋がっているノード間ではMACアドレスで通信を行う。具体的には、`arp`リクエストを送ってIPアドレスからMACアドレスを取得する。ここで仮に、自分が所属しているサブネットが分からないとしよう。経路制御のテーブルには、隣のノードからもらったエントリに+1ホップした値を記録するから、隣のノードが自分自身をホップ数0として紹介してくれればそれで済みそうである。しかし大規模なネットワークを考えると、サブネット内にデバイスが出たり入ったりする度に、全てのデバイスと経路情報を交換し合うというのは明らかに効率が悪い。そこで、ホストがルーターに接続した際、予めホスト自身が直接接続できるサブネットが渡されるようになっている。これはDHCPの枠組みで行われる。

#### CIDRとVLSM

次に、ホストではなくルーターがネットワークに接続する場合を考える。ネットワークにルーターを追加することは、新たにサブネットを切り出すことを意味する。

従来はサブネットマスクが固定長だったため、割当予定のサブネット内で最大のホスト数を持つサブネットに合わせてサブネットの大きさを決めていた。しかし、サブネット毎にホスト数が大きく違う場合は無駄が生じる。そこでサブネットマスクの大きさを可変にできるようになった（VLSM）。

VLSMを用いたサブネット構築の演習問題を次の通りまとめた。

- [◆VLSMにおけるサブネットの分割方法](https://atnetwork.info/ccna3/vlsm03.html)
- [ルーティング編<第3回>　VLSMと経路集約](https://xtech.nikkei.com/it/article/COLUMN/20060205/228596/)

<!-- AWSのVPCの最適なサブネット切りの考察 -->

<!-- 1人1つIPアドレスを持っていた日本の会社の話 -->

<!-- > [!NOTE] キリ番のIPアドレスってどうやって取得してるの？ -->

### IPv6

<!-- > [!NOTE] IPv4は繋がらないのにIPv6は繋がる事象ってなぜ起きるの？ -->

<!-- https://x.com/xhiroga/status/1731655265290981481 -->

<!-- > [!NOTE] IPアドレスの開示請求とIPv6って関係ある？ -->

## TCP, UDP

### ポート番号

TCP/UDPでは、パケットを目的のプロセスに届けるためにポート番号が含まれている。しかし、より具体的にプロセス識別子を用いたり、あるいは抽象的にアプリケーションのID（そんなものは存在しないが、敢えて言えばmacOS, iOSにおけるバンドルID）を用いることで、新たにIDを増やすことを避けなかったのはなぜだろうか？TCPはクライアント・サーバーを区別しないプロトコルなので、プロセス識別子のような予め予測できない値を用いると通信を待ち受けるのが困難になる。一方、アプリケーションのIDを用いるとクライアント側がアプリケーションを多重起動するのが困難になる。よって新たに番号を設けて通信を識別したものと考えられる。

TCPとUDPで同じポート番号を利用しても、通信が混線することはない。では、なぜTCPとUDPは同じ仕様のポート番号を使っているのだろうか？UDPのRFCを読んでみたが、理由は分からなかった。[^rfc768]

[^rfc768]: [RFC768](https://datatracker.ietf.org/doc/rfc768/)


## ルーティングプロトコル

<!-- > [!NOTE] BGPを自分で取得するには？ -->

## アプリケーションプロトコル

## References

[マスタリングTCP/IP](https://amzn.to/3x7Mq7z)
